from defenses.PurificationDefenses.DiffPure.DiffusionClassifier import (
    NoisedEDMEulerIntegralCondDenoiseDC,
    NoisedEDMEulerIntegralDC,
    NoisedEDMEulerIntegralExactQDC,
    EDMEulerIntegralDC,
)
from models.unets import get_edm_cifar_uncond, get_edm_cifar_cond
from models import BaseNormModel
import torch
from data import get_CIFAR10_test
from defenses.RandomizedSmoothing.core import Smooth
from tester import certify_robustness, test_acc
import argparse
from utils.seed import set_seed
import math
from matplotlib import pyplot as plt


norm = torch.tensor(
    [
        6.0830e-02,
        2.7204e-02,
        1.6213e-02,
        9.7331e-03,
        7.1704e-03,
        5.1360e-03,
        4.0372e-03,
        3.0498e-03,
        2.4450e-03,
        2.0410e-03,
        1.7694e-03,
        1.4354e-03,
        1.2821e-03,
        1.1344e-03,
        9.7996e-04,
        8.8158e-04,
        7.4879e-04,
        7.2043e-04,
        6.5652e-04,
        6.0176e-04,
        5.2744e-04,
        4.9032e-04,
        4.5606e-04,
        4.0618e-04,
        3.8142e-04,
        3.6847e-04,
        3.2985e-04,
        3.1807e-04,
        2.8729e-04,
        2.5229e-04,
        2.5035e-04,
        2.2439e-04,
        2.3624e-04,
        2.1964e-04,
        1.9955e-04,
        1.9474e-04,
        1.9146e-04,
        1.7788e-04,
        1.6712e-04,
        1.5229e-04,
        1.5219e-04,
        1.5000e-04,
        1.4102e-04,
        1.2875e-04,
        1.2719e-04,
        1.1995e-04,
        1.1987e-04,
        1.0999e-04,
        1.1086e-04,
        1.0360e-04,
        9.5587e-05,
        9.6891e-05,
        9.8239e-05,
        9.1287e-05,
        8.6439e-05,
        8.2291e-05,
        8.2898e-05,
        8.0256e-05,
        7.6571e-05,
        7.1341e-05,
        7.7584e-05,
        6.8506e-05,
        7.1903e-05,
        6.5990e-05,
        6.6595e-05,
        6.2101e-05,
        6.1171e-05,
        6.2975e-05,
        6.0295e-05,
        5.8312e-05,
        5.7244e-05,
        5.7178e-05,
        5.2605e-05,
        5.2328e-05,
        5.0653e-05,
        4.9036e-05,
        5.0208e-05,
        4.8145e-05,
        4.6819e-05,
        4.4532e-05,
        4.3077e-05,
        4.2579e-05,
        4.3851e-05,
        4.1056e-05,
        4.2086e-05,
        3.7426e-05,
        3.7422e-05,
        3.8105e-05,
        3.7577e-05,
        3.7190e-05,
        3.5603e-05,
        3.6321e-05,
        3.4379e-05,
        3.3430e-05,
        3.1613e-05,
        3.1698e-05,
        3.3307e-05,
        3.2623e-05,
        3.1232e-05,
        3.0935e-05,
        2.9291e-05,
        3.0735e-05,
        2.8915e-05,
        2.9596e-05,
        2.8313e-05,
        2.8327e-05,
        2.7608e-05,
        2.8084e-05,
        2.5746e-05,
        2.5490e-05,
        2.6626e-05,
        2.5739e-05,
        2.6045e-05,
        2.4561e-05,
        2.3871e-05,
        2.3717e-05,
        2.3737e-05,
        2.4509e-05,
        2.3829e-05,
        2.1651e-05,
        2.4787e-05,
        2.3202e-05,
        2.2526e-05,
        2.1701e-05,
        2.2949e-05,
        2.1378e-05,
        2.0387e-05,
        2.0987e-05,
        1.8644e-05,
        2.0528e-05,
        1.9351e-05,
        1.9340e-05,
        1.8742e-05,
        1.9120e-05,
        1.8643e-05,
        1.8689e-05,
        1.8587e-05,
        1.8038e-05,
        1.7994e-05,
        1.7999e-05,
        1.8074e-05,
        1.7817e-05,
        1.7393e-05,
        1.6877e-05,
        1.6646e-05,
        1.6284e-05,
        1.7156e-05,
        1.5498e-05,
        1.6642e-05,
        1.5791e-05,
        1.5950e-05,
        1.6384e-05,
        1.6141e-05,
        1.5321e-05,
        1.5430e-05,
        1.5619e-05,
        1.4426e-05,
        1.4738e-05,
        1.4037e-05,
        1.4656e-05,
        1.3970e-05,
        1.4202e-05,
        1.4259e-05,
        1.4511e-05,
        1.3351e-05,
        1.3088e-05,
        1.3541e-05,
        1.3762e-05,
        1.3058e-05,
        1.3186e-05,
        1.3299e-05,
        1.3236e-05,
        1.2990e-05,
        1.2870e-05,
        1.2356e-05,
        1.2573e-05,
        1.2166e-05,
        1.2716e-05,
        1.2149e-05,
        1.1832e-05,
        1.2275e-05,
        1.1538e-05,
        1.1731e-05,
        1.1916e-05,
        1.2021e-05,
        1.1082e-05,
        1.1640e-05,
        1.1113e-05,
        1.1322e-05,
        1.1332e-05,
        1.1688e-05,
        1.0819e-05,
        1.0791e-05,
        1.0722e-05,
        1.1327e-05,
        1.0505e-05,
        1.0683e-05,
        1.0212e-05,
        1.1050e-05,
        1.0423e-05,
        1.0163e-05,
        1.0110e-05,
        1.0288e-05,
        9.7492e-06,
        9.7923e-06,
        9.7520e-06,
        9.8693e-06,
        1.0136e-05,
        1.0078e-05,
        9.4607e-06,
        9.4031e-06,
        9.4820e-06,
        9.3117e-06,
        9.3528e-06,
        9.1511e-06,
        9.1006e-06,
        9.2909e-06,
        8.7685e-06,
        8.9714e-06,
        8.8055e-06,
        8.8826e-06,
        9.0893e-06,
        8.9710e-06,
        8.9138e-06,
        8.8376e-06,
        8.5773e-06,
        8.8625e-06,
        8.3392e-06,
        8.2867e-06,
        8.5839e-06,
        8.5818e-06,
        8.2976e-06,
        8.5592e-06,
        8.0784e-06,
        7.9562e-06,
        7.7890e-06,
        7.9055e-06,
        8.2977e-06,
        8.0915e-06,
        7.8896e-06,
        7.8913e-06,
        7.9658e-06,
        8.0112e-06,
        7.6607e-06,
        7.9370e-06,
        7.4541e-06,
        7.5688e-06,
        7.6377e-06,
        7.6553e-06,
        7.7248e-06,
        7.3192e-06,
        7.5445e-06,
        7.3979e-06,
        7.3430e-06,
        7.1770e-06,
        7.4060e-06,
        7.2232e-06,
        7.4084e-06,
        6.9839e-06,
        7.4395e-06,
        6.9195e-06,
        6.9094e-06,
        6.8396e-06,
        6.9636e-06,
        6.6095e-06,
        6.7131e-06,
        6.7353e-06,
        6.7370e-06,
        6.7174e-06,
        6.8862e-06,
        6.6443e-06,
        6.8307e-06,
        6.4866e-06,
        6.5260e-06,
        6.6054e-06,
        6.7270e-06,
        7.0300e-06,
        6.3811e-06,
        6.2681e-06,
        6.4147e-06,
        6.1924e-06,
        6.3088e-06,
        6.3536e-06,
        6.2419e-06,
        6.4997e-06,
        5.9780e-06,
        5.8677e-06,
        6.4342e-06,
        5.9705e-06,
        6.1620e-06,
        5.9583e-06,
        6.1789e-06,
        6.0097e-06,
        5.8330e-06,
        6.2281e-06,
        5.8698e-06,
        5.8379e-06,
        5.8135e-06,
        5.6961e-06,
        5.9763e-06,
        5.6682e-06,
        6.0395e-06,
        5.7100e-06,
        5.9871e-06,
        5.7644e-06,
        5.5948e-06,
        5.4711e-06,
        5.5204e-06,
        5.6756e-06,
        5.5888e-06,
        5.4963e-06,
        5.5109e-06,
        5.4125e-06,
        5.4918e-06,
        5.2837e-06,
        5.5388e-06,
        5.1131e-06,
        5.2122e-06,
        5.4058e-06,
        5.4240e-06,
        5.3953e-06,
        5.1908e-06,
        5.2091e-06,
        5.0182e-06,
        5.0907e-06,
        5.1714e-06,
        5.0994e-06,
        4.9679e-06,
        5.0857e-06,
        5.0984e-06,
        5.2747e-06,
        5.2710e-06,
        5.0985e-06,
        4.8384e-06,
        4.8090e-06,
        5.1104e-06,
        4.8754e-06,
        5.1789e-06,
        4.8562e-06,
        4.8746e-06,
        4.8232e-06,
        4.6364e-06,
        4.8398e-06,
        5.1719e-06,
        4.9867e-06,
        4.7756e-06,
        4.7517e-06,
        4.7429e-06,
        4.5627e-06,
        4.6653e-06,
        4.5309e-06,
        4.5740e-06,
        4.6167e-06,
        4.7144e-06,
        4.5470e-06,
        4.7283e-06,
        4.5655e-06,
        4.4392e-06,
        4.7156e-06,
        4.3950e-06,
        4.4747e-06,
        4.4313e-06,
        4.6087e-06,
        4.2819e-06,
        4.3499e-06,
        4.4018e-06,
        4.5623e-06,
        4.2166e-06,
        4.3522e-06,
        4.2671e-06,
        4.2310e-06,
        4.2868e-06,
        4.3851e-06,
        4.1351e-06,
        4.0885e-06,
        4.0401e-06,
        3.9601e-06,
        4.2657e-06,
        4.0168e-06,
        4.2981e-06,
        4.1681e-06,
        4.1248e-06,
        4.2931e-06,
        4.0732e-06,
        4.2825e-06,
        4.1397e-06,
        3.8755e-06,
        3.9244e-06,
        4.1752e-06,
        4.2867e-06,
        4.1585e-06,
        3.8573e-06,
        4.0186e-06,
        3.9082e-06,
        3.8835e-06,
        4.0971e-06,
        3.8873e-06,
        3.8188e-06,
        3.7415e-06,
        3.8508e-06,
        3.8861e-06,
        3.7605e-06,
        3.8131e-06,
        3.9527e-06,
        3.7433e-06,
        3.7608e-06,
        3.5760e-06,
        3.6399e-06,
        3.7014e-06,
        3.7841e-06,
        3.6639e-06,
        3.7096e-06,
        3.9313e-06,
        3.4984e-06,
        3.6187e-06,
        3.7089e-06,
        3.4788e-06,
        3.5341e-06,
        3.6882e-06,
        3.6389e-06,
        3.6680e-06,
        3.6198e-06,
        3.6549e-06,
        3.3956e-06,
        3.5098e-06,
        3.8448e-06,
        3.4683e-06,
        3.4152e-06,
        3.4182e-06,
        3.4541e-06,
        3.5490e-06,
        3.4995e-06,
        3.6469e-06,
        3.5228e-06,
        3.3184e-06,
        3.4280e-06,
        3.5665e-06,
        3.4560e-06,
        3.5401e-06,
        3.5643e-06,
        3.4219e-06,
        3.2393e-06,
        3.3398e-06,
        3.4107e-06,
        3.2947e-06,
        3.2671e-06,
        3.3112e-06,
        3.3504e-06,
        3.2319e-06,
        3.5236e-06,
        3.3102e-06,
        3.1167e-06,
        3.1722e-06,
        3.2129e-06,
        3.2236e-06,
        3.1430e-06,
        3.2382e-06,
        3.2156e-06,
        3.1554e-06,
        3.1424e-06,
        3.2309e-06,
        3.1167e-06,
        3.0833e-06,
        3.0945e-06,
        3.4002e-06,
        3.2805e-06,
        3.0789e-06,
        3.0150e-06,
        3.0474e-06,
        3.1320e-06,
        3.0281e-06,
        3.0285e-06,
        3.2157e-06,
        3.0721e-06,
        3.0790e-06,
        2.9945e-06,
        2.9755e-06,
        2.9184e-06,
        2.9971e-06,
        2.8591e-06,
        2.9723e-06,
        3.0358e-06,
        2.8103e-06,
        2.9198e-06,
        2.9507e-06,
        2.9534e-06,
        3.0047e-06,
        2.8237e-06,
        2.8501e-06,
        2.8102e-06,
        2.8544e-06,
        2.8220e-06,
        2.8614e-06,
        2.9482e-06,
        2.6268e-06,
        2.7610e-06,
        2.8530e-06,
        2.9428e-06,
        2.7943e-06,
        2.6670e-06,
        2.8435e-06,
        2.7610e-06,
        2.8406e-06,
        2.8091e-06,
        2.7544e-06,
        2.7578e-06,
        2.7183e-06,
        2.7728e-06,
        2.8581e-06,
        2.6126e-06,
        2.8057e-06,
        2.7483e-06,
        2.9153e-06,
        2.7646e-06,
        2.7432e-06,
        2.6728e-06,
        2.6101e-06,
        2.7096e-06,
        2.7033e-06,
        2.6080e-06,
        2.6748e-06,
        2.6457e-06,
        2.7327e-06,
        2.5470e-06,
        2.5948e-06,
        2.6997e-06,
        2.7985e-06,
        2.5209e-06,
        2.5314e-06,
        2.7235e-06,
        2.5073e-06,
        2.6414e-06,
        2.4992e-06,
        2.4853e-06,
        2.5838e-06,
        2.5773e-06,
        2.5456e-06,
        2.4960e-06,
        2.5909e-06,
        2.5757e-06,
        2.5482e-06,
        2.5481e-06,
        2.4203e-06,
        2.4140e-06,
        2.5612e-06,
        2.5125e-06,
        2.5397e-06,
        2.3987e-06,
        2.3988e-06,
        2.5049e-06,
        2.3290e-06,
        2.4000e-06,
        2.4596e-06,
        2.4220e-06,
        2.3649e-06,
        2.5498e-06,
        2.3310e-06,
        2.3833e-06,
        2.3515e-06,
        2.4103e-06,
        2.4045e-06,
        2.2735e-06,
        2.4275e-06,
        2.3657e-06,
        2.5301e-06,
        2.3071e-06,
        2.4004e-06,
        2.4962e-06,
        2.3711e-06,
        2.2928e-06,
        2.3764e-06,
        2.2122e-06,
        2.2740e-06,
        2.3151e-06,
        2.3335e-06,
        2.3048e-06,
        2.2266e-06,
        2.3294e-06,
        2.3087e-06,
        2.2525e-06,
        2.3381e-06,
        2.2319e-06,
        2.3455e-06,
        2.2328e-06,
        2.2977e-06,
        2.1504e-06,
        2.2371e-06,
        2.1755e-06,
        2.2039e-06,
        2.2030e-06,
        2.1040e-06,
        2.2906e-06,
        2.1533e-06,
        2.2168e-06,
        2.1283e-06,
        2.1860e-06,
        2.1203e-06,
        2.1983e-06,
        2.1132e-06,
        2.1847e-06,
        2.1296e-06,
        2.1072e-06,
        2.2327e-06,
        2.1110e-06,
        2.1320e-06,
        2.1696e-06,
        2.1478e-06,
        2.0684e-06,
        1.9975e-06,
        2.1412e-06,
        2.1076e-06,
        2.0578e-06,
        2.2169e-06,
        2.2265e-06,
        2.0090e-06,
        2.0386e-06,
        2.0805e-06,
        2.1053e-06,
        2.1037e-06,
        2.0416e-06,
        2.2339e-06,
        2.0542e-06,
        2.0669e-06,
        2.0217e-06,
        2.0306e-06,
        1.9683e-06,
        1.9325e-06,
        1.9858e-06,
        1.9953e-06,
        2.0094e-06,
        1.9460e-06,
        2.0393e-06,
        2.0191e-06,
        2.0857e-06,
        1.9963e-06,
        2.0494e-06,
        1.8991e-06,
        1.9909e-06,
        1.9122e-06,
        1.9326e-06,
        1.9135e-06,
        1.9510e-06,
        1.9431e-06,
        2.0537e-06,
        2.0570e-06,
        2.0263e-06,
        1.9136e-06,
        2.0306e-06,
        1.8601e-06,
        1.8901e-06,
        1.8148e-06,
        1.9202e-06,
        1.9245e-06,
        1.9044e-06,
        1.8795e-06,
        1.8458e-06,
        1.9166e-06,
        1.8974e-06,
        1.8621e-06,
        1.8895e-06,
        1.8032e-06,
        1.8785e-06,
        1.8797e-06,
        2.0012e-06,
        1.7663e-06,
        1.9262e-06,
        1.9304e-06,
        1.8712e-06,
        1.8787e-06,
        1.7623e-06,
        1.9685e-06,
        1.8125e-06,
        1.9529e-06,
        1.7481e-06,
        1.8815e-06,
        1.7755e-06,
        1.7744e-06,
        1.8724e-06,
        1.8286e-06,
        1.7781e-06,
        1.8231e-06,
        1.7993e-06,
        1.7367e-06,
        1.7723e-06,
        1.7005e-06,
        1.7195e-06,
        1.6477e-06,
        1.7292e-06,
        1.7322e-06,
        1.8015e-06,
        1.7302e-06,
        1.7030e-06,
        1.7652e-06,
        1.7474e-06,
        1.7683e-06,
        1.7292e-06,
        1.6904e-06,
        1.6942e-06,
        1.6807e-06,
        1.7217e-06,
        1.7253e-06,
        1.6909e-06,
        1.7040e-06,
        1.7811e-06,
        1.6401e-06,
        1.7513e-06,
        1.6376e-06,
        1.6228e-06,
        1.7103e-06,
        1.6217e-06,
        1.6713e-06,
        1.7296e-06,
        1.6413e-06,
        1.6259e-06,
        1.5516e-06,
        1.7267e-06,
        1.6487e-06,
        1.7846e-06,
        1.5559e-06,
        1.5896e-06,
        1.6268e-06,
        1.5894e-06,
        1.5469e-06,
        1.6940e-06,
        1.6732e-06,
        1.6454e-06,
        1.5649e-06,
        1.6713e-06,
        1.5664e-06,
        1.6563e-06,
        1.5440e-06,
        1.5386e-06,
        1.5843e-06,
        1.6713e-06,
        1.5457e-06,
        1.7248e-06,
        1.5362e-06,
        1.6806e-06,
        1.5980e-06,
        1.5495e-06,
        1.5492e-06,
        1.5668e-06,
        1.5299e-06,
        1.5296e-06,
        1.5828e-06,
        1.5356e-06,
        1.6370e-06,
        1.5002e-06,
        1.5099e-06,
        1.6037e-06,
        1.5933e-06,
        1.6232e-06,
        1.5249e-06,
        1.5583e-06,
        1.5603e-06,
        1.6697e-06,
        1.5384e-06,
        1.4812e-06,
        1.4405e-06,
        1.5840e-06,
        1.5519e-06,
        1.5203e-06,
        1.5780e-06,
        1.4929e-06,
        1.5707e-06,
        1.5423e-06,
        1.5255e-06,
        1.4799e-06,
        1.4848e-06,
        1.5243e-06,
        1.6519e-06,
        1.4709e-06,
        1.4916e-06,
        1.5458e-06,
        1.4570e-06,
        1.5023e-06,
        1.5254e-06,
        1.4522e-06,
        1.3782e-06,
        1.4929e-06,
        1.4944e-06,
        1.4264e-06,
        1.5839e-06,
        1.4308e-06,
        1.4142e-06,
        1.3794e-06,
        1.4765e-06,
        1.3850e-06,
        1.4010e-06,
        1.3703e-06,
        1.5209e-06,
        1.4522e-06,
        1.4576e-06,
        1.5080e-06,
        1.4496e-06,
        1.3385e-06,
        1.4805e-06,
        1.3371e-06,
        1.3928e-06,
        1.4011e-06,
        1.3778e-06,
        1.3485e-06,
        1.3960e-06,
        1.3883e-06,
        1.4355e-06,
        1.3412e-06,
        1.4301e-06,
        1.3737e-06,
        1.3547e-06,
        1.3087e-06,
        1.3796e-06,
        1.3814e-06,
        1.4205e-06,
        1.3129e-06,
        1.4328e-06,
        1.3797e-06,
        1.3325e-06,
        1.3731e-06,
        1.3714e-06,
        1.3659e-06,
        1.2860e-06,
        1.3561e-06,
        1.3484e-06,
        1.3509e-06,
        1.3936e-06,
        1.4671e-06,
        1.3070e-06,
        1.3089e-06,
        1.3185e-06,
        1.3569e-06,
        1.3045e-06,
        1.3407e-06,
        1.3331e-06,
        1.2789e-06,
        1.3214e-06,
        1.3585e-06,
        1.3269e-06,
        1.3501e-06,
        1.2580e-06,
        1.4249e-06,
        1.4086e-06,
        1.3141e-06,
        1.2896e-06,
        1.2869e-06,
        1.2922e-06,
        1.2578e-06,
        1.2647e-06,
        1.2877e-06,
        1.2584e-06,
        1.3123e-06,
        1.3397e-06,
        1.1881e-06,
        1.2772e-06,
        1.3225e-06,
        1.3068e-06,
        1.2684e-06,
        1.4689e-06,
        1.3041e-06,
        1.2396e-06,
        1.1992e-06,
        1.2355e-06,
        1.1925e-06,
        1.2423e-06,
        1.2601e-06,
        1.2334e-06,
        1.3217e-06,
        1.2190e-06,
        1.2313e-06,
        1.2165e-06,
        1.2004e-06,
        1.3560e-06,
        1.2795e-06,
        1.1549e-06,
        1.3101e-06,
        1.2193e-06,
        1.3199e-06,
        1.2457e-06,
        1.2041e-06,
        1.2014e-06,
        1.2341e-06,
        1.2853e-06,
        1.2019e-06,
        1.1453e-06,
        1.1786e-06,
        1.1750e-06,
        1.2448e-06,
        1.1788e-06,
        1.1252e-06,
        1.2591e-06,
        1.1295e-06,
        1.3023e-06,
        1.1418e-06,
        1.1514e-06,
        1.1902e-06,
        1.2518e-06,
        1.2312e-06,
        1.1604e-06,
        1.1480e-06,
        1.1348e-06,
        1.1014e-06,
        1.1141e-06,
        1.1880e-06,
        1.2256e-06,
        1.1977e-06,
        1.1895e-06,
        1.2652e-06,
        1.1672e-06,
        1.1967e-06,
        1.1298e-06,
        1.2508e-06,
        1.1518e-06,
        1.1321e-06,
        1.2078e-06,
        1.1726e-06,
        1.1635e-06,
        1.2389e-06,
        1.1708e-06,
        1.1088e-06,
        1.2119e-06,
        1.1369e-06,
        1.0798e-06,
        1.1487e-06,
        1.1175e-06,
        1.1093e-06,
        1.2060e-06,
        1.1840e-06,
        1.1490e-06,
        1.0926e-06,
        1.2359e-06,
        1.1300e-06,
        1.1157e-06,
        1.0733e-06,
        1.0987e-06,
        1.1089e-06,
        1.1211e-06,
        1.1827e-06,
        1.0774e-06,
        1.0534e-06,
        1.1159e-06,
        1.1134e-06,
        1.1702e-06,
        1.0525e-06,
        1.0537e-06,
        1.0593e-06,
        1.0548e-06,
        1.1145e-06,
        1.1446e-06,
        1.0349e-06,
        1.1588e-06,
        1.0943e-06,
        1.1058e-06,
        1.0750e-06,
        1.0841e-06,
        1.2511e-06,
        1.0561e-06,
        1.1314e-06,
        1.1584e-06,
        1.0576e-06,
        1.1002e-06,
        1.0149e-06,
        1.0943e-06,
        1.0551e-06,
        1.0502e-06,
        1.1301e-06,
        1.0399e-06,
        1.0188e-06,
        1.0298e-06,
        1.0323e-06,
        1.0726e-06,
        1.0731e-06,
        1.0755e-06,
        1.0920e-06,
        9.5451e-07,
        1.0634e-06,
        1.0525e-06,
        1.0205e-06,
        1.0231e-06,
        1.1583e-06,
        1.0983e-06,
        1.0541e-06,
        1.0250e-06,
        1.0143e-06,
        1.0585e-06,
        1.0142e-06,
        1.0278e-06,
        9.9299e-07,
        1.0194e-06,
        1.0769e-06,
        1.0154e-06,
        1.0260e-06,
        1.0531e-06,
        1.0209e-06,
        1.0347e-06,
        1.0343e-06,
        1.0585e-06,
        1.0199e-06,
        1.0610e-06,
        1.0028e-06,
    ]
)

set_seed(1)

parser = argparse.ArgumentParser()
parser.add_argument("--begin", type=int)
parser.add_argument("--end", type=int)
parser.add_argument("--sigma", type=float, default=0.25)
parser.add_argument("--t_steps", type=int, default=1001)
args = parser.parse_args()
begin, end, sigma, t_steps = args.begin, args.end, args.sigma, args.t_steps

loader = get_CIFAR10_test(batch_size=1)
loader = [item for i, item in enumerate(loader) if begin <= i < end]
device = torch.device("cuda")
classifier = NoisedEDMEulerIntegralExactQDC(get_edm_cifar_cond(), sigma=sigma, steps=t_steps)

# derivative weight

steps = t_steps
timesteps = classifier.timesteps
sigma_i, sigma_i_plus_one, sigma_t = timesteps[:-1], timesteps[1:], timesteps[0]
sigma_data = 0.5
P_mean = -1.2
P_std = 1.2
p_x = classifier.p_x
dt = classifier.dt[:-1]
weight = (sigma_i**2 + sigma_data**2) / (sigma_i * sigma_data) ** 2 * p_x[:-1] * dt

derivative_weight = (
    weight * sigma_i_plus_one**2 * (sigma_i_plus_one**2 - sigma_t**2) / 4 / dt**2 / (sigma_i**2 - sigma_t**2)
)

derivative_weight = derivative_weight[1:]
# derivative_weight[:20] = 0
# # identity. Already depreciated
# additional_weight = torch.linspace(
#     start=1, end=1, steps=(derivative_weight.numel() - 20), device=derivative_weight.device
# )
# additional_weight = torch.cat([torch.zeros((20,), device=derivative_weight.device), additional_weight], dim=0)
# derivative_weight = derivative_weight * additional_weight
# # print(derivative_weight)
# # find weight for leq 20
# x = torch.exp(torch.linspace(-100, 1, 20))
# derivative_weight[:20] = x
# print(derivative_weight)
# print(norm[::8][:20])
# print(1/ norm[::8][:20])
# assert False

# assert False
# 分段点
# 10: 76.95
# 20: 83.20
# 30: 82.81
# 40: 81.64
# 50 75.78

# additional weight (modified)
# 1-10000 80.07
# 1-100 81.25
# 1-1 83.20
# 100-1 82.42
# 10000-1 82.42


# additional weight
# 1-10000 83.98
# 1-1000 83.98
# 1-100 83.98
# 1-10 83.98
# 1-1 83.20
# 2-1 83.20
# 3-1 83.20
# 5-1 83.20
# 10-1 83.20
# 50-1 82.42
# 300-1 82.42
# 3000-1 82.42
# 30000-1 82.42

# other weight

#
# classifier.share_noise = True
# x1, y1, x2, y2 = 0.75, 0, 3, 100
# w = (y1 - y2) / (x1 - x2) * classifier.timesteps + y1 - (y1 - y2) / (x1 - x2) * x1
# w[w<0] = 0
# classifier.weight = w[1:]
# x1, y1, x2, y2 = 0.5, 0.0001, classifier.timesteps[100], w2[0]
# w1 = (y1 - y2) / (x1 - x2) * classifier.timesteps[:100] + y1 - (y1 - y2) / (x1 - x2) * x1
# classifier.weight = 0.0001 / norm.cuda()
# # classifier.weight[200:] = derivative_weight[202:]
# plt.plot(classifier.timesteps[1:].cpu().numpy(), classifier.weight.cpu().numpy())
# plt.show()
# assert False

# assign weight
classifier.weight = derivative_weight
# classifier.weight = 0.001 / norm[::8].cuda()
classifier.share_noise = True
classifier.eval().requires_grad_(False).to(device)
test_acc(BaseNormModel(classifier, lambda x: x + torch.randn_like(x) * sigma), loader)

# g = Smooth(classifier, batch_size=1, verbose=True)
# g = Smooth(classifier, batch_size=32, verbose=False)
# certify_robustness(g, loader, n0=10, n=1000)
